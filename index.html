import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, LineChart, Line } from 'recharts';

// --- Assets and Data (Mocked) ---
const mockUsers = {
    'client1': { username: 'client1', password: '123', role: 'לקוח', avatar: 'https://placehold.co/96x96/4F46E5/FFFFFF?text=לקוח' },
    'driver1': { username: 'driver1', password: '123', role: 'מוביל', avatar: 'https://placehold.co/96x96/10B981/FFFFFF?text=מוביל' },
    'admin1': { username: 'admin1', password: '123', role: 'מנהל', avatar: 'https://placehold.co/96x96/6B7280/FFFFFF?text=מנהל' }
};

const mockCities = ['תל אביב', 'ירושלים', 'חיפה', 'באר שבע', 'אשדוד', 'נתניה', 'רמת גן'];

// Mocked Driver data, including vehicle type for matching
const mockDrivers = [
    { name: 'הובלות אקספרס', truckType: 'משאית הובלות', specialty: 'הובלת דירה', rating: 4.8, distance: 15, success: 0 },
    { name: 'לוגיסטיקה בקירור', truckType: 'משאית קירור', specialty: 'הובלה בקירור', rating: 4.9, distance: 20, success: 0 },
    { name: 'מוביל העמק', truckType: 'משאית קטנה', specialty: 'מטענים קטנים', rating: 4.5, distance: 5, success: 0 },
    { name: 'פסולת ופינוי', truckType: 'משאית פינוי', specialty: 'הובלת פסולת', rating: 4.7, distance: 25, success: 0 },
    { name: 'אחים לדרך', truckType: 'משאית הובלות', specialty: 'הובלת דירה', rating: 4.6, distance: 10, success: 0 },
    { name: 'סלואו מוברס', truckType: 'משאית הובלות', specialty: 'הובלת דירה', rating: 4.2, distance: 30, success: 0 },
];

const mockVehicleTypes = [
    { name: 'משאית הובלות', cargoTypes: ['ריהוט וקרטונים', 'ציוד משרדי'] },
    { name: 'משאית קירור', cargoTypes: ['מזון קפוא', 'תרופות'] },
    { name: 'משאית קטנה', cargoTypes: ['מטענים קטנים', 'חפצים אישיים'] },
    { name: 'משאית פינוי', cargoTypes: ['פסולת בניין', 'גרוטאות'] },
];

const mockCargoCatalog = [
    { name: 'ריהוט וקרטונים', type: 'הובלת דירה', weight: 500, dimensions: { length: 3, width: 2, height: 2 }, volume: 12 },
    { name: 'ציוד משרדי', type: 'הובלה מסחרית', weight: 200, dimensions: { length: 2, width: 1.5, height: 1.5 }, volume: 4.5 },
    { name: 'מכשירי חשמל', type: 'הובלה מסחרית', weight: 150, dimensions: { length: 1, width: 1, height: 1.5 }, volume: 1.5 },
    { name: 'מטענים קטנים', type: 'הובלת מטענים קטנים', weight: 50, dimensions: { length: 0.5, width: 0.5, height: 0.5 }, volume: 0.125 },
];

const mockOrders = [
    { month: 'ינואר', orders: 12, revenue: 15000 },
    { month: 'פברואר', orders: 15, revenue: 18000 },
    { month: 'מרץ', orders: 18, revenue: 22000 },
    { month: 'אפריל', orders: 20, revenue: 25000 },
    { month: 'מאי', orders: 25, revenue: 30000 },
];

const logoUrl = "https://i.imgur.com/8Q9j73h.png"; // Placeholder logo URL

// --- Components ---

const Toast = ({ message, type, onDismiss }) => {
    useEffect(() => {
        const timer = setTimeout(() => {
            onDismiss();
        }, 5000);
        return () => clearTimeout(timer);
    }, [onDismiss]);

    return (
        <motion.div
            className={`toast rounded-md px-6 py-4 shadow-lg text-white font-medium ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}
            initial={{ x: '100%', opacity: 0 }}
            animate={{ x: 0, opacity: 1 }}
            exit={{ x: '100%', opacity: 0 }}
            transition={{ type: 'spring', damping: 20, stiffness: 300 }}
        >
            {message}
        </motion.div>
    );
};

const Modal = ({ isOpen, onClose, title, children }) => {
    return (
        <AnimatePresence>
            {isOpen && (
                <motion.div
                    className="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50 p-4"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    onClick={onClose}
                >
                    <motion.div
                        className="bg-white rounded-2xl p-8 shadow-2xl max-w-lg w-full"
                        initial={{ scale: 0.9, y: 50 }}
                        animate={{ scale: 1, y: 0 }}
                        exit={{ scale: 0.9, y: 50 }}
                        onClick={(e) => e.stopPropagation()}
                    >
                        <h2 className="text-2xl font-bold mb-4 text-center">{title}</h2>
                        {children}
                        <button onClick={onClose} className="mt-4 text-gray-500 hover:text-gray-700">סגור</button>
                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>
    );
};

const ProgressStepper = ({ currentStep }) => {
    const steps = ['פרטי לקוח', 'פרטי אספקה', 'פרטי מטען'];
    const totalSteps = steps.length;
    const progress = (currentStep / totalSteps) * 100;
    const progressText = (currentStep === 1) ? "כמעט שם! עוד קצת מידע ונתחיל" : (currentStep === 2) ? "מצויין, בחר כעת את פרטי המטען" : "השלמת את הטופס, עכשיו בחר מוביל";

    return (
        <div className="w-full mb-8">
            <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-semibold text-gray-700">{progressText}</span>
                <span className="text-sm font-bold text-indigo-600">{Math.round(progress)}%</span>
            </div>
            <div className="h-2 bg-gray-200 rounded-full">
                <motion.div
                    className="h-full bg-indigo-600 rounded-full"
                    initial={{ width: '0%' }}
                    animate={{ width: `${progress}%` }}
                    transition={{ duration: 0.5 }}
                />
            </div>
            <div className="flex justify-between mt-2 text-xs font-medium text-gray-500">
                {steps.map((step, index) => (
                    <span key={index} className={index + 1 <= currentStep ? 'text-indigo-600 font-semibold' : ''}>
                        {step}
                    </span>
                ))}
            </div>
        </div>
    );
};

const AvatarUploader = ({ avatarUrl, onUpload }) => {
    return (
        <div className="relative w-24 h-24 rounded-full overflow-hidden bg-gray-200 border-4 border-white shadow-lg mx-auto">
            <img src={avatarUrl} alt="User Avatar" className="w-full h-full object-cover" />
            <input
                type="file"
                className="absolute inset-0 opacity-0 cursor-pointer"
                onChange={(e) => onUpload(e.target.files[0])}
            />
        </div>
    );
};

const Dashboard = () => {
    return (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-8">
            <h2 className="text-3xl font-bold text-gray-800">לוח מחוונים</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 className="text-xl font-semibold mb-4">היסטוריית הזמנות חודשית</h3>
                    <ResponsiveContainer width="100%" height={200}>
                        <BarChart data={mockOrders}>
                            <XAxis dataKey="month" />
                            <YAxis />
                            <Tooltip />
                            <Bar dataKey="orders" fill="#0b6f3f" name="הזמנות" />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 className="text-xl font-semibold mb-4">הכנסות חודשיות</h3>
                    <ResponsiveContainer width="100%" height={200}>
                        <LineChart data={mockOrders}>
                            <XAxis dataKey="month" />
                            <YAxis />
                            <Tooltip />
                            <Line type="monotone" dataKey="revenue" stroke="#0a84ff" name="הכנסות" />
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            </div>
        </motion.div>
    );
};

// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [loginModalOpen, setLoginModalOpen] = useState(false);
    const [whatsappModalOpen, setWhatsappModalOpen] = useState(false);
    const [documentModalOpen, setDocumentModalOpen] = useState(false);
    const [toasts, setToasts] = useState([]);
    const [currentStep, setCurrentStep] = useState(1);
    const [formData, setFormData] = useState({
        clientName: '', clientWhatsapp: '+972508861080', isBusiness: false, businessId: '',
        cityFrom: '', cityTo: '', stopPoints: 0, timeWindow: '',
        cargoType: '', cargoWeight: '', cargoLength: '', cargoWidth: '', cargoHeight: '', cargoQuantity: 1, requiredEscort: false,
        accessIssues: [],
        mediaFiles: [], shippingDoc: null
    });
    const [filteredDrivers, setFilteredDrivers] = useState([]);
    const [suggestedTruckType, setSuggestedTruckType] = useState('לא נבחר');
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [currentPage, setCurrentPage] = useState('home');

    // --- Mock APIs and Handlers ---
    const showToast = (message, type = 'success') => {
        const newToast = { id: Date.now(), message, type };
        setToasts(prev => [...prev, newToast]);
    };

    const handleLogin = (e) => {
        e.preventDefault();
        const username = e.target.username.value;
        const password = e.target.password.value;
        const role = e.target.role.value;
        const matchedUser = mockUsers[username];

        if (matchedUser && matchedUser.password === password && matchedUser.role === role) {
            setUser(matchedUser);
            setLoginModalOpen(false);
            showToast(`ברוכים הבאים, ${matchedUser.role}!`, 'success');
        } else {
            showToast('שם משתמש או סיסמה שגויים.', 'error');
        }
    };

    const handleAvatarUpload = (file) => {
        // Mocking file upload to a sheet/drive
        const reader = new FileReader();
        reader.onloadend = () => {
            setUser({ ...user, avatar: reader.result });
            showToast('תמונת האווטאר עודכנה בהצלחה!');
        };
        reader.readAsDataURL(file);
    };

    const handleFormChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: type === 'checkbox' ? checked : value
        }));
    };

    const handleNextStep = () => {
        // Simple form validation before moving
        if (currentStep === 1) {
            if (!formData.clientName || !formData.clientWhatsapp) {
                showToast('אנא מלא את כל השדות.', 'error');
                return;
            }
        }
        if (currentStep === 2) {
            if (!formData.cityFrom || !formData.cityTo) {
                showToast('אנא מלא את כל שדות האספקה.', 'error');
                return;
            }
            // Mocking distance calculation and truck suggestion
            const distance = calculateDistance(formData.cityFrom, formData.cityTo);
            const cargo = mockCargoCatalog.find(c => c.name === formData.cargoType);
            if (cargo) {
                const recommendedTruck = mockVehicleTypes.find(v => v.cargoTypes.includes(cargo.name));
                setSuggestedTruckType(recommendedTruck ? recommendedTruck.name : 'לא נמצאה המלצה');
            }
            showToast(`מרחק משוער בין הערים הוא ${distance} ק"מ.`);
        }
        setCurrentStep(prev => prev + 1);
    };

    const handleFormSubmit = (e) => {
        e.preventDefault();
        showToast('...מבצע התאמת מובילים. אנא המתן.', 'success');
        const loadDetails = { ...formData };
        
        // Mocking the driver matching algorithm
        const cargoDetails = mockCargoCatalog.find(c => c.name === loadDetails.cargoType);
        
        const scoredDrivers = mockDrivers.map(driver => {
            let score = 0;
            const distanceMatch = 1 - (Math.abs(driver.distance - calculateDistance(loadDetails.cityFrom, loadDetails.cityTo)) / 100);
            
            // 1. Truck Type Match (40%)
            const vehicle = mockVehicleTypes.find(v => v.name === driver.truckType);
            if (vehicle && cargoDetails && vehicle.cargoTypes.includes(cargoDetails.name)) {
                score += 40;
            }
            
            // 2. Weight/Dimensions Match (30%)
            // Simplified mock: assume all drivers can handle the weight
            score += 30;
            
            // 3. Distance Match (20%)
            score += Math.max(0, Math.min(20, distanceMatch * 20));
            
            // 4. Rating Match (10%)
            score += Math.max(0, Math.min(10, (driver.rating / 5) * 10));

            return { ...driver, success: Math.round(score) };
        });

        setFilteredDrivers(scoredDrivers.sort((a, b) => b.success - a.success));
        showToast('ההזמנה נשלחה בהצלחה! בחר מוביל מהטבלה.', 'success');
    };
    
    // Mock function for distance calculation
    const calculateDistance = (cityA, cityB) => {
        const hash = (s) => s.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        return Math.abs(hash(cityA) - hash(cityB)) % 100 + 10;
    };
    
    const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            // Mocking file upload to Google Drive
            showToast(`...מעלה קובץ ל-Google Drive`, 'success');
            setTimeout(() => {
                setFormData(prev => ({ ...prev, shippingDoc: file }));
                showToast(`הקובץ "${file.name}" הועלה בהצלחה!`);
            }, 1500);
        }
    };
    
    const scrollToTop = () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // New function to render the form based on the current step
    const renderFormStep = () => {
        switch (currentStep) {
            case 1:
                return (
                    <motion.div
                        key="step1"
                        initial={{ opacity: 0, x: 200 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -200 }}
                        transition={{ duration: 0.5 }}
                        className="space-y-6"
                    >
                        <h2 className="text-xl font-bold mb-4">פרטי לקוח</h2>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">שם מלא</label>
                            <input type="text" name="clientName" value={formData.clientName} onChange={handleFormChange} required className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">מספר טלפון (וואטסאפ)</label>
                            <input type="tel" name="clientWhatsapp" value={formData.clientWhatsapp} onChange={handleFormChange} required className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <div className="flex items-center">
                            <input type="checkbox" name="isBusiness" checked={formData.isBusiness} onChange={handleFormChange} id="isBusiness" className="h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                            <label htmlFor="isBusiness" className="mr-2 block text-gray-700 font-medium">הובלה עסקית</label>
                        </div>
                        {formData.isBusiness && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ duration: 0.5 }}>
                                <label className="block text-gray-700 font-medium mb-1">ח.פ. או מספר עוסק מורשה</label>
                                <input type="text" name="businessId" value={formData.businessId} onChange={handleFormChange} className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            </motion.div>
                        )}
                        <button type="button" onClick={handleNextStep} className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition">הבא</button>
                    </motion.div>
                );
            case 2:
                return (
                    <motion.div
                        key="step2"
                        initial={{ opacity: 0, x: 200 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -200 }}
                        transition={{ duration: 0.5 }}
                        className="space-y-6"
                    >
                        <h2 className="text-xl font-bold mb-4">פרטי אספקה</h2>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">עיר מוצא</label>
                            <select name="cityFrom" value={formData.cityFrom} onChange={handleFormChange} required className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">בחר עיר</option>
                                {mockCities.map(city => <option key={city} value={city}>{city}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">עיר יעד</label>
                            <select name="cityTo" value={formData.cityTo} onChange={handleFormChange} required className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">בחר עיר</option>
                                {mockCities.map(city => <option key={city} value={city}>{city}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">נקודות עצירה נוספות</label>
                            <input type="number" name="stopPoints" value={formData.stopPoints} onChange={handleFormChange} min="0" className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">חלון זמנים מועדף</label>
                            <input type="text" name="timeWindow" value={formData.timeWindow} onChange={handleFormChange} placeholder="לדוגמה: 10:00-14:00" className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <div className="flex justify-between space-x-2">
                            <button type="button" onClick={() => setCurrentStep(1)} className="w-1/2 py-3 border border-indigo-600 text-indigo-600 rounded-lg font-bold hover:bg-indigo-50 transition">חזור</button>
                            <button type="button" onClick={handleNextStep} className="w-1/2 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition">הבא</button>
                        </div>
                    </motion.div>
                );
            case 3:
                return (
                    <motion.div
                        key="step3"
                        initial={{ opacity: 0, x: 200 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -200 }}
                        transition={{ duration: 0.5 }}
                        className="space-y-6"
                    >
                        <h2 className="text-xl font-bold mb-4">פרטי מטען</h2>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">סוג מטען</label>
                            <select name="cargoType" value={formData.cargoType} onChange={handleFormChange} required className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">בחר סוג</option>
                                {mockCargoCatalog.map(cargo => <option key={cargo.name} value={cargo.name}>{cargo.name}</option>)}
                            </select>
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-700 font-medium">סוג משאית מומלץ:</span>
                            <span className="font-bold text-indigo-600">{suggestedTruckType}</span>
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">הערות נוספות</label>
                            <textarea name="notes" value={formData.notes} onChange={handleFormChange} className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">העלה מסמכי משלוח</label>
                            <input type="file" onChange={handleFileUpload} className="w-full p-3 border border-gray-300 rounded-lg" />
                            {formData.shippingDoc && (
                                <p className="mt-2 text-sm text-green-600">קובץ: {formData.shippingDoc.name} נטען.</p>
                            )}
                        </div>
                        <div className="flex justify-between space-x-2">
                            <button type="button" onClick={() => setCurrentStep(2)} className="w-1/2 py-3 border border-indigo-600 text-indigo-600 rounded-lg font-bold hover:bg-indigo-50 transition">חזור</button>
                            <button type="submit" className="w-1/2 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">מצא מוביל</button>
                        </div>
                    </motion.div>
                );
            default:
                return null;
        }
    };

    if (!user) {
        return (
            <div className="flex flex-col items-center justify-center min-h-screen p-8" style={{ background: '#f8f9fa' }}>
                <img src={logoUrl} alt="Freight Broker Logo" className="mb-8 h-24" />
                <h1 className="text-4xl font-bold mb-8 text-center" style={{ fontFamily: 'Almarai, sans-serif' }}>מערכת תיווך הובלות</h1>
                <div className="glassmorphism-card text-center p-8 max-w-sm w-full">
                    <p className="text-gray-600 mb-6">אנא בחר תפקיד כדי להתחבר:</p>
                    <div className="flex flex-col space-y-4">
                        <button onClick={() => { setLoginModalOpen(true); }} className="w-full py-3 px-6 rounded-lg text-white font-bold bg-indigo-600 hover:bg-indigo-700 transition">לקוח</button>
                        <button onClick={() => { setLoginModalOpen(true); }} className="w-full py-3 px-6 rounded-lg text-white font-bold bg-green-600 hover:bg-green-700 transition">מוביל</button>
                        <button onClick={() => { setLoginModalOpen(true); }} className="w-full py-3 px-6 rounded-lg text-white font-bold bg-gray-600 hover:bg-gray-700 transition">מנהל</button>
                    </div>
                </div>
                <Modal isOpen={loginModalOpen} onClose={() => setLoginModalOpen(false)} title="התחברות">
                    <form onSubmit={handleLogin} className="space-y-4">
                        <label className="block">שם משתמש</label>
                        <input type="text" name="username" required className="w-full p-2 border rounded-md" />
                        <label className="block">סיסמה</label>
                        <input type="password" name="password" required className="w-full p-2 border rounded-md" />
                        <select name="role" required className="w-full p-2 border rounded-md hidden">
                            <option value="לקוח">לקוח</option>
                            <option value="מוביל">מוביל</option>
                            <option value="מנהל">מנהל</option>
                        </select>
                        <button type="submit" className="w-full py-3 bg-indigo-600 text-white rounded-md">התחבר</button>
                    </form>
                </Modal>
            </div>
        );
    }

    const renderPage = () => {
        switch (currentPage) {
            case 'home':
                return (
                    <div className="max-w-4xl mx-auto glassmorphism-card p-8 sm:p-12">
                        <div className="flex flex-col sm:flex-row items-center sm:items-start justify-between mb-8 text-center sm:text-right">
                            <div className="mb-4 sm:mb-0">
                                <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">שלום, {user.username}! 👋</h1>
                                <p className="text-gray-600 text-lg">בוא נתחיל הזמנה חדשה.</p>
                            </div>
                            <AvatarUploader avatarUrl={user.avatar} onUpload={handleAvatarUpload} />
                        </div>
                        
                        <ProgressStepper currentStep={currentStep} />
                        
                        <AnimatePresence mode="wait">
                            <form onSubmit={handleFormSubmit}>
                                {renderFormStep()}
                            </form>
                        </AnimatePresence>
                        
                        {filteredDrivers.length > 0 && (
                            <motion.div
                                className="mt-12"
                                initial={{ opacity: 0, y: 20 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ duration: 0.5 }}
                            >
                                <h2 className="text-xl font-bold mb-4 text-gray-800 text-center">מובילים מותאמים עבורך</h2>
                                <div className="overflow-x-auto rounded-lg shadow-lg">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">שם המוביל</th>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">סוג משאית</th>
                                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">אחוז התאמה</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {filteredDrivers.map((driver) => (
                                                <tr key={driver.name} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{driver.name}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{driver.truckType}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <div className="w-24 bg-gray-200 rounded-full h-2">
                                                            <div className="bg-green-500 h-2 rounded-full" style={{ width: `${driver.success}%` }}></div>
                                                        </div>
                                                        <span className="ml-2">{driver.success}%</span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </motion.div>
                        )}
                    </div>
                );
            case 'dashboard':
                return (
                    <div className="max-w-4xl mx-auto glassmorphism-card p-8 sm:p-12">
                        <Dashboard />
                    </div>
                );
            case 'about':
                return (
                    <div className="max-w-4xl mx-auto glassmorphism-card p-8 sm:p-12">
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">אודות המערכת</h2>
                        <p className="text-gray-700 leading-loose">
                            מערכת תיווך ההובלות שלנו נוצרה כדי לפשט את תהליך ההובלה עבור לקוחות ומובילים כאחד. אנו מאמינים בשקיפות, יעילות וחיבור נכון בין הצדדים, כדי שכל הובלה תתבצע בצורה הטובה ביותר.
                            המערכת מאפשרת ללקוחות ליצור הזמנה במהירות, למלא את כל הפרטים הרלוונטיים ולקבל המלצות למובילים המתאימים ביותר. המובילים מקבלים גישה למכרזים מותאמים אישית, המאפשרת להם למקסם את הרווחים ולנהל את לוח הזמנים שלהם ביעילות.
                        </p>
                    </div>
                );
            case 'support':
                return (
                    <div className="max-w-4xl mx-auto glassmorphism-card p-8 sm:p-12">
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">תמיכה טכנית</h2>
                        <p className="text-gray-700 mb-6">יש לך שאלה? מלא את הפרטים ונחזור אליך בהקדם.</p>
                        <form className="space-y-4">
                            <div>
                                <label className="block text-gray-600 font-medium mb-1">נושא הפניה</label>
                                <input type="text" className="w-full p-3 border rounded-md" />
                            </div>
                            <div>
                                <label className="block text-gray-600 font-medium mb-1">הודעה</label>
                                <textarea className="w-full p-3 border rounded-md h-32"></textarea>
                            </div>
                            <button type="submit" className="w-full py-3 bg-indigo-600 text-white rounded-md font-bold">שלח הודעה</button>
                            <div className="text-center mt-4">
                                <span className="text-gray-500">או שתף את פרטי התמיכה בוואטסאפ:</span>
                                <a href="https://wa.me/972508861080?text=שלום, אני זקוק לתמיכה טכנית." target="_blank" className="block mt-2 py-2 px-4 rounded-lg bg-green-500 text-white font-bold">
                                    <span className="flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                        <span className="ml-2">שתף בוואטסאפ</span>
                                    </span>
                                </a>
                            </div>
                        </form>
                    </div>
                );
            default:
                return null;
        }
    };

    return (
        <div className="min-h-screen relative overflow-hidden" style={{ background: '#f8f9fa' }}>
            {/* Sidebar */}
            <AnimatePresence>
                {sidebarOpen && (
                    <motion.div
                        className="fixed inset-y-0 right-0 w-64 bg-white shadow-xl z-50 p-6"
                        initial={{ x: '100%' }}
                        animate={{ x: 0 }}
                        exit={{ x: '100%' }}
                        transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                    >
                        <button onClick={() => setSidebarOpen(false)} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                        <img src={logoUrl} alt="Logo" className="w-32 mx-auto mb-8" />
                        <nav className="space-y-4 text-gray-700 font-bold" style={{ fontFamily: 'Assistant, sans-serif' }}>
                            <a onClick={() => { setCurrentPage('home'); setSidebarOpen(false); }} className={`block cursor-pointer p-2 rounded-lg hover:bg-gray-100 ${currentPage === 'home' && 'bg-gray-200'}`}>דף הבית</a>
                            <a onClick={() => { setCurrentPage('dashboard'); setSidebarOpen(false); }} className={`block cursor-pointer p-2 rounded-lg hover:bg-gray-100 ${currentPage === 'dashboard' && 'bg-gray-200'}`}>לוח מחוונים</a>
                            <a onClick={() => { setCurrentPage('about'); setSidebarOpen(false); }} className={`block cursor-pointer p-2 rounded-lg hover:bg-gray-100 ${currentPage === 'about' && 'bg-gray-200'}`}>אודות</a>
                            <a onClick={() => { setCurrentPage('support'); setSidebarOpen(false); }} className={`block cursor-pointer p-2 rounded-lg hover:bg-gray-100 ${currentPage === 'support' && 'bg-gray-200'}`}>תמיכה טכנית</a>
                        </nav>
                    </motion.div>
                )}
            </AnimatePresence>
            
            {/* Header */}
            <div className="sticky top-0 right-0 w-full bg-white bg-opacity-75 backdrop-blur-lg shadow-sm p-4 z-40">
                <div className="flex justify-between items-center max-w-7xl mx-auto">
                    <img src={logoUrl} alt="Logo" className="h-10" />
                    <button onClick={() => setSidebarOpen(true)} className="p-2 rounded-md hover:bg-gray-100 transition">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                </div>
            </div>

            {/* Main Content */}
            <div className="p-8">
                {renderPage()}
            </div>

            {/* Floating Tools */}
            <div className="fixed bottom-8 right-8 flex flex-col items-center space-y-4 z-40">
                <button onClick={scrollToTop} className="w-12 h-12 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center transition hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>
                </button>
                <button onClick={() => setWhatsappModalOpen(true)} className="w-12 h-12 rounded-full bg-green-500 text-white shadow-lg flex items-center justify-center transition hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>

            {/* Modals and Toasts */}
            <Modal isOpen={loginModalOpen} onClose={() => setLoginModalOpen(false)} title="התחברות">
                <form onSubmit={handleLogin} className="space-y-4">
                    <label className="block">שם משתמש</label>
                    <input type="text" name="username" required className="w-full p-2 border rounded-md" />
                    <label className="block">סיסמה</label>
                    <input type="password" name="password" required className="w-full p-2 border rounded-md" />
                    <select name="role" required className="w-full p-2 border rounded-md hidden">
                        <option value="לקוח">לקוח</option>
                        <option value="מוביל">מוביל</option>
                        <option value="מנהל">מנהל</option>
                    </select>
                    <button type="submit" className="w-full py-3 bg-indigo-600 text-white rounded-md">התחבר</button>
                </form>
            </Modal>

            <Modal isOpen={whatsappModalOpen} onClose={() => setWhatsappModalOpen(false)} title="עזרה בווצאפ">
                <p className="text-gray-600 mb-4">שלח הודעה למספר +972508861080 לקבלת עזרה מהירה.</p>
                <a href="https://wa.me/972508861080?text=שלום, אני זקוק לעזרה עם ההזמנה שלי." target="_blank" className="block w-full text-center py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition">
                    שלח הודעה
                </a>
            </Modal>
            
            <Modal isOpen={documentModalOpen} onClose={() => setDocumentModalOpen(false)} title="מסמך מצורף">
                <div className="aspect-w-3 aspect-h-4">
                    {/* Mocked PDF embed. In a real app, this would be a viewer like react-pdf. */}
                    <img src="https://placehold.co/400x500/E5E7EB/4B5563?text=Mirrored+Document" alt="Mock Document" className="w-full h-full object-contain" />
                </div>
            </Modal>

            <div className="fixed top-4 left-4 z-50 space-y-2">
                <AnimatePresence>
                    {toasts.map(toast => (
                        <Toast key={toast.id} message={toast.message} type={toast.type} onDismiss={() => setToasts(prev => prev.filter(t => t.id !== toast.id))} />
                    ))}
                </AnimatePresence>
            </div>
        </div>
    );
}

// Global styles for the app
const style = `
    body {
        font-family: 'Inter', sans-serif;
        direction: rtl;
        text-align: right;
        background: #f0f4f8; /* A subtle, professional background */
    }
    .glassmorphism-card {
        background-color: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 20px;
    }
    .floating-btn {
        background-color: #0b6f3f; /* WhatsApp Green */
        border-radius: 50%;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    @import url('https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Assistant:wght@400;700&family=Inter:wght@400;500;700&display=swap');
    
    .recharts-wrapper text {
        direction: ltr !important;
    }
`;
// Export a dummy style object to satisfy the React renderer.
export const AppStyle = style;
